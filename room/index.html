<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Version: 20250830f - JavaScriptæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£ç‰ˆ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨å±‹é¸æŠ - æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šã‚¢ãƒ—ãƒª</title>
    
    <!-- PWA ãƒ¡ã‚¿ã‚¿ã‚° -->
    <meta name="description" content="æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®èª­ã¿å–ã‚Šã‚’ç®¡ç†ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Š">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2JmZiIvPgo8c3ZnIHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="../css_styles/room_select.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <!-- PWA Utilities -->
    <script src="/pwa-utils.js"></script>
    
    <!-- Performance Monitor -->
    <script src="/performance-monitor.js"></script>
    
    <!-- Navigation Diagnostics -->
    <script src="/navigation-diagnostics.js"></script>
    
    <!-- Navigation Debug Test (é–‹ç™ºç”¨) -->
    <script src="/navigation-debug-test.js"></script>
    
    <!-- Navigation Fix Test Suite -->
    <script src="/navigation-fix-test.js"></script>
    
    <!-- Character Encoding Fix Test -->
    <script src="/encoding-fix-test.js"></script>
    
    <!-- Force Refresh Validation Test (é–‹ç™ºç”¨) -->
    <script src="/force-refresh-validation-test.js"></script>
</head>
<body>
    <!-- Material UI AppBar -->
    <header class="MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic mui-elevation-4" role="banner">
      <nav class="MuiToolbar-root MuiToolbar-regular" aria-label="éƒ¨å±‹é¸æŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <button class="MuiIconButton-root MuiIconButton-colorInherit" onclick="goBack()" aria-label="æˆ»ã‚‹">
          <span class="material-icons MuiSvgIcon-root">arrow_back</span>
        </button>
        <span class="MuiTypography-root MuiTypography-h6 app-title" aria-label="ç”»é¢ã‚¿ã‚¤ãƒˆãƒ«">éƒ¨å±‹é¸æŠ</span>
      </nav>
    </header>

    <main class="MuiContainer-root MuiContainer-maxWidthLg" style="padding-top:32px;" role="main" aria-label="éƒ¨å±‹é¸æŠãƒ¡ã‚¤ãƒ³">
      <!-- ç‰©ä»¶åã‚«ãƒ¼ãƒ‰ -->
      <section class="MuiCard-root MuiPaper-root MuiPaper-elevation1 property-card" aria-label="ç‰©ä»¶æƒ…å ±" tabindex="0" role="region">
        <div class="MuiCardHeader-root property-header">
          <span class="material-icons MuiSvgIcon-root property-icon" aria-hidden="true">home</span>
          <span class="MuiTypography-root MuiTypography-h5" id="propertyName">ç‰©ä»¶åèª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
      </section>

      <!-- ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆ -->
      <div class="MuiAlert-root MuiAlert-standardError" id="errorMessage" style="display:none;" role="alert" aria-live="assertive">
        <span class="MuiAlert-icon"><span class="material-icons MuiSvgIcon-root" aria-hidden="true">error</span></span>
        <span class="MuiAlert-message" id="errorText"></span>
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
      <div class="loading-container" id="loading" aria-live="polite" aria-busy="true">
        <span class="MuiCircularProgress-root" aria-label="èª­ã¿è¾¼ã¿ä¸­"></span>
        <span class="MuiTypography-root MuiTypography-body1">éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>

      <!-- éƒ¨å±‹ã‚°ãƒªãƒƒãƒ‰ -->
      <section class="room-grid" id="roomGrid" style="display:none;" aria-label="éƒ¨å±‹ä¸€è¦§" role="list"></section>

      <!-- å®Œäº†ãƒœã‚¿ãƒ³ -->
      <div class="complete-button-container">
        <button class="MuiButton-root MuiButton-contained MuiButton-containedPrimary MuiButton-sizeLarge complete-button" id="completeInspectionBtn" onclick="completeInspection()" style="display:none;" aria-label="ã“ã®ç‰©ä»¶ã®æ¤œé‡ã‚’å®Œäº†ã™ã‚‹" tabindex="0" role="button">
          <span class="material-icons MuiSvgIcon-root" aria-hidden="true">check_circle</span>
          <span class="MuiButton-label">ã“ã®ç‰©ä»¶ã®æ¤œé‡ã‚’å®Œäº†ã™ã‚‹</span>
        </button>
      </div>
    </main>

<script>
        // ğŸš€ Room Select App v20250830g - JavaScriptæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£å®Œäº†ç‰ˆ + å®‰å®šå‹•ä½œç‰ˆ
        console.log('ğŸš€ Room Select App v20250830g - JavaScriptæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£å®Œäº†ç‰ˆ');
        console.log('ğŸ”§ SessionStorageç¶™ç¶š: property_select.htmlã‹ã‚‰ã®é«˜é€Ÿé·ç§»å¯¾å¿œ');
        console.log('ğŸ”§ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½çµ±åˆ: LocalStorage + å·®åˆ†æ›´æ–°å¯¾å¿œ');
        console.log('ğŸ”§ APIçµ±ä¸€: getRoomså¾“æ¥APIä½¿ç”¨ï¼ˆå®‰å®šå‹•ä½œï¼‰');
        console.log('ğŸ”§ ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½: ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šãƒ‡ãƒ¼ã‚¿äº‹å‰å–å¾—');
        console.log('ğŸ”§ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ  + å³åº§è¡¨ç¤º');
        console.log('ğŸ› ï¸ ä¿®æ­£: gasWebAppUrlå¤‰æ•°ã‚¹ã‚³ãƒ¼ãƒ—å•é¡Œè§£æ±º');
        console.log('ğŸ›¡ï¸ å¼·åŒ–: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸');
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
        if (window.pwaUtils) {
            const cacheStats = window.pwaUtils.getCacheStats();
            console.log('ğŸ“Š ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆ:', cacheStats);
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º - React Error #418å¯¾ç­–
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = String(message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            errorDiv.style.display = 'flex';
        }
        
        // Ripple effect for buttons and cards
        function addRippleEffect(element) {
            element.addEventListener('click', function(e) {
                const circle = document.createElement('span');
                circle.className = 'ripple';
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                circle.style.width = circle.style.height = size + 'px';
                circle.style.left = (e.clientX - rect.left - size / 2) + 'px';
                circle.style.top = (e.clientY - rect.top - size / 2) + 'px';
                element.appendChild(circle);
                setTimeout(() => {
                    if (circle.parentNode) {
                        circle.parentNode.removeChild(circle);
                    }
                }, 600);
            });
        }

        // åˆæœŸåŒ–å‡¦ç†ã‚’é–¢æ•°å†…ã«ç§»å‹•ï¼ˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
        async function initializeRoomSelect() {
            try {
                console.log('[room_select] åˆæœŸåŒ–å‡¦ç†é–‹å§‹');
                
                // Service Workerç™»éŒ²
                if (window.pwaUtils) {
                    try {
                        const registration = await window.pwaUtils.registerServiceWorker();
                        console.log('âœ… [room_select] Service Workerç™»éŒ²æˆåŠŸ:', registration?.scope);
                    } catch (error) {
                        console.error('âŒ [room_select] Service Workerç™»éŒ²å¤±æ•—:', error);
                    }
                }
                
                // GAS Web App URLå–å¾—ï¼ˆSessionStorage â†’ LocalStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                let gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
                console.log('[room_select] SessionStorage gasWebAppUrl:', gasWebAppUrl);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: LocalStorageã‹ã‚‰å–å¾—
                if (!gasWebAppUrl) {
                    gasWebAppUrl = localStorage.getItem('gasWebAppUrl');
                    console.log('[room_select] LocalStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ gasWebAppUrl:', gasWebAppUrl);
                    
                    // LocalStorageã‹ã‚‰å–å¾—ã§ããŸå ´åˆã¯SessionStorageã«å¾©å…ƒ
                    if (gasWebAppUrl) {
                        sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
                        console.log('[room_select] âœ… SessionStorageå¾©å…ƒå®Œäº†');
                    }
                }
                
                // URLæ¤œè¨¼ã¨æ‰‹å‹•è¨­å®šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!gasWebAppUrl || !gasWebAppUrl.includes('script.google.com')) {
                    console.error('[room_select] â˜…CRITICAL: Invalid gasWebAppUrl:', gasWebAppUrl);
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æ¥å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
                    const userInput = prompt(
                        'Google Apps Script Web App URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\\n\\n' +
                        'URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\\n\\n' +
                        'ä¾‹: https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
                        'https://script.google.com/macros/s/'
                    );
                    
                    if (userInput && userInput.includes('script.google.com')) {
                        gasWebAppUrl = userInput;
                        sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
                        localStorage.setItem('gasWebAppUrl', gasWebAppUrl); // æ°¸ç¶šåŒ–
                        console.log('[room_select] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›URLè¨­å®šå®Œäº†:', gasWebAppUrl);
                    } else {
                        showError('æœ‰åŠ¹ãªGoogle Apps Script URLãŒå¿…è¦ã§ã™ã€‚ç‰©ä»¶é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                        document.getElementById('loading').innerHTML = '<div class="loading-spinner"></div><p class="loading-text">Web App URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                        setTimeout(() => window.location.href = '/property_select.html', 3000);
                        return;
                    }
                }
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç‰©ä»¶IDã‚’å–å¾—
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('propertyId');
                
                console.log('[room_select] URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª:', {
                    propertyId: propertyId,
                    fullUrl: window.location.href,
                    searchParams: window.location.search
                });
                
                if (!propertyId) {
                    console.error('[room_select] ç‰©ä»¶IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    if (confirm('ç‰©ä»¶IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                        window.location.href = '/property_select.html';
                    } else {
                        document.getElementById('loading').innerHTML = '<div class="loading-spinner"></div><p class="loading-text">ç‰©ä»¶IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                        setTimeout(() => window.location.href = '/property_select.html', 3000);
                    }
                    return;
                }
                
                console.log('[room_select] ç‰©ä»¶IDç¢ºèªå®Œäº†:', propertyId);
                
                // æ¤œé‡å®Œäº†å¾Œã®æˆ»ã‚Šç”¨ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
                const forceRefresh = sessionStorage.getItem('forceRefreshRooms');
                const updatedRoomId = sessionStorage.getItem('updatedRoomId');
                const lastUpdateTime = sessionStorage.getItem('lastUpdateTime');
                
                console.log('[room_select] æˆ»ã‚Šç”¨ãƒ•ãƒ©ã‚°ç¢ºèª:', {
                    forceRefresh,
                    updatedRoomId,
                    lastUpdateTime: lastUpdateTime ? new Date(parseInt(lastUpdateTime)).toLocaleString() : null
                });
                
                // ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹å ´åˆã¯ã‚¯ãƒªã‚¢ã—ã¦å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                if (forceRefresh === 'true') {
                    console.log('[room_select] ğŸ”„ æ¤œé‡å®Œäº†å¾Œã®æˆ»ã‚Šå‡¦ç† - å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Ÿè¡Œ');
                    sessionStorage.removeItem('forceRefreshRooms');
                    sessionStorage.removeItem('updatedRoomId');
                    sessionStorage.removeItem('lastUpdateTime');
                    
                    // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                    window.forceRefreshData = true;
                    window.updatedRoomId = updatedRoomId;
                }
                
                // æ­£å¸¸ãªå ´åˆã®ã¿loadRoomDataã‚’å®Ÿè¡Œ
                console.log('[room_select] window.onloadã«loadRoomDataè¨­å®š');
                window.onload = function() {
                    console.log('[room_select] window.onloadç™ºç« - loadRoomDataå®Ÿè¡Œé–‹å§‹');
                    loadRoomData();
                };
                
                // æ—¢ã«ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
                if (document.readyState === 'complete') {
                    console.log('[room_select] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ¸ˆã¿ - loadRoomDataå³åº§å®Ÿè¡Œ');
                    loadRoomData();
                }
            } catch (error) {
                console.error('[room_select] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('åˆæœŸåŒ–å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®‰å…¨ã«å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeRoomSelect);
        } else {
            // ã™ã§ã«DOMèª­ã¿è¾¼ã¿å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
            initializeRoomSelect();
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã‚’å®Œå…¨ã«ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function blockAllKeyEvents(e) {
            // ESCã€Tabã€Enterã€Spaceã€Arrow keysç­‰ã‚’ç„¡åŠ¹åŒ–
            const blockedKeys = ['Escape', 'Tab', 'Enter', ' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            if (blockedKeys.includes(e.key) || e.keyCode === 27 || e.keyCode === 9) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹æ™‚ã®æ“ä½œãƒ–ãƒ­ãƒƒã‚¯è¨­å®š
        function enableLoadingBlock() {
            document.body.style.overflow = 'hidden';
            document.body.style.pointerEvents = 'none';
            document.addEventListener('keydown', blockAllKeyEvents, true);
            document.addEventListener('keyup', blockAllKeyEvents, true);
            document.addEventListener('keypress', blockAllKeyEvents, true);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ã¯æ“ä½œå¯èƒ½ã«ã™ã‚‹
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.pointerEvents = 'all';
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†æ™‚ã®æ“ä½œãƒ–ãƒ­ãƒƒã‚¯è§£é™¤
        function disableLoadingBlock() {
            document.body.style.overflow = '';
            document.body.style.pointerEvents = '';
            document.removeEventListener('keydown', blockAllKeyEvents, true);
            document.removeEventListener('keyup', blockAllKeyEvents, true);
            document.removeEventListener('keypress', blockAllKeyEvents, true);
        }

        async function loadRoomData() {
            console.log('[room_select] ğŸš€ loadRoomDataé–¢æ•°é–‹å§‹ - Cache+Light APIå¯¾å¿œ');
            let rooms = [];
            let propertyName = 'ç‰©ä»¶åä¸æ˜';
            
            try {
                console.log('[room_select] enableLoadingBlocké–‹å§‹');
                enableLoadingBlock();
                
                const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('propertyId');
                
                console.log('[room_select] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª:', {
                    gasWebAppUrl: gasWebAppUrl ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š',
                    propertyId: propertyId
                });
                
                if (!gasWebAppUrl || !propertyId) {
                    throw new Error('å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
                const forceRefresh = window.forceRefreshData;
                console.log('[room_select] å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°:', forceRefresh);
                
                // ğŸ”„ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¦APIç›´è¡Œ
                if (forceRefresh) {
                    console.log('[room_select] ğŸš€ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ¢ãƒ¼ãƒ‰ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ã‚­ãƒƒãƒ—ã—ã¦APIç›´è¡Œ');
                    // Step 3ã®APIå‘¼ã³å‡ºã—ã«ç›´è¡Œã™ã‚‹ãŸã‚ã€Step 1, 2ã‚’ã‚¹ã‚­ãƒƒãƒ—
                } else {
                    // Step 1: SessionStorageã‹ã‚‰ç¶™ç¶šãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªï¼ˆproperty_select.htmlã‹ã‚‰ã®é«˜é€Ÿé·ç§»ï¼‰
                    const sessionRooms = sessionStorage.getItem('selectedRooms');
                    const sessionPropertyName = sessionStorage.getItem('selectedPropertyName');
                    const sessionPropertyId = sessionStorage.getItem('selectedPropertyId');
                    
                    console.log('[room_select] ğŸ”„ SessionStorageç¢ºèª:', {
                        forceRefresh: forceRefresh,
                        hasRooms: !!sessionRooms,
                        hasPropertyName: !!sessionPropertyName,
                        sessionPropertyId: sessionPropertyId,
                        currentPropertyId: propertyId,
                        propertyIdMatch: sessionPropertyId === propertyId
                    });
                    
                    if (sessionRooms && sessionPropertyId === propertyId && sessionPropertyName) {
                    // SessionStorageã‹ã‚‰å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    try {
                        const parsedRooms = JSON.parse(sessionRooms);
                        if (Array.isArray(parsedRooms)) {
                            console.log('[room_select] âš¡ SessionStorageç¶™ç¶šãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ - å³åº§è¡¨ç¤º:', parsedRooms.length, 'ä»¶');
                            rooms = parsedRooms;
                            propertyName = sessionPropertyName;
                            
                            // å³åº§ã«è¡¨ç¤º
                            document.getElementById('propertyName').textContent = propertyName;
                            displayRooms(rooms);
                            updateCompleteButton(rooms);
                            
                            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å·®åˆ†æ›´æ–°ã‚’å®Ÿè¡Œ
                            console.log('[room_select] ğŸ”„ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å·®åˆ†æ›´æ–°é–‹å§‹...');
                            setTimeout(() => performRoomDeltaUpdateBackground(propertyId), 100);
                            return; // SessionStorageç¶™ç¶šæ™‚ã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
                        }
                    } catch (parseError) {
                        console.warn('[room_select] SessionStorageãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—:', parseError);
                    }
                    }
                    
                    // Step 2: LocalStorageã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
                    const roomCacheKey = `rooms_${propertyId}`;
                    const isCacheValid = window.pwaUtils?.isCacheValid(roomCacheKey);
                    
                    console.log('[room_select] ğŸ—„ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª:', { 
                        key: roomCacheKey, 
                        valid: isCacheValid,
                        forceRefresh: false,
                        skipCache: false 
                    });
                    
                    if (isCacheValid) {
                        const cachedData = window.pwaUtils.getCacheData(roomCacheKey);
                        console.log('[room_select] âš¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ:', cachedData?.data?.length || 0, 'ä»¶');
                        
                        if (cachedData?.data && Array.isArray(cachedData.data)) {
                            rooms = cachedData.data;
                            
                            // ç‰©ä»¶åã‚’SessionStorageã¾ãŸã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
                            propertyName = sessionPropertyName || 'ç‰©ä»¶åå–å¾—ä¸­...';
                            
                            console.log('[room_select] ğŸš€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ - é«˜é€Ÿè¡¨ç¤º');
                            document.getElementById('propertyName').textContent = propertyName;
                            displayRooms(rooms);
                            updateCompleteButton(rooms);
                            
                            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å·®åˆ†æ›´æ–°
                            setTimeout(() => performRoomDeltaUpdateBackground(propertyId, cachedData.timestamp), 100);
                            return;
                        }
                    }
                }
                
                // Step 3: è»½é‡APIä½¿ç”¨ï¼ˆforceRefreshæ™‚ã‚‚ã—ãã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ï¼‰
                if (forceRefresh) {
                    console.log('[room_select] ğŸš€ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ - æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰å–å¾—');
                } else {
                    console.log('[room_select] ğŸš€ è»½é‡APIä½¿ç”¨ - getRoomsLight (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹å¾Œ)');
                }
                const fetchUrl = `${gasWebAppUrl}?action=getRoomsLight&propertyId=${encodeURIComponent(propertyId)}&cache=${Date.now()}`;
                console.log('[room_select] Light APIå‘¼ã³å‡ºã—:', fetchUrl);
                
                const response = await fetch(fetchUrl);
                console.log('[room_select] Light APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.ok);
                
                if (!response.ok) {
                    // è»½é‡APIå¤±æ•—æ™‚ã¯å¾“æ¥APIã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    console.warn('[room_select] Light APIå¤±æ•— - å¾“æ¥APIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                    return await loadRoomDataLegacy(propertyId, gasWebAppUrl);
                }
                
                const data = await response.json();
                console.log('[room_select] Light APIãƒ‡ãƒ¼ã‚¿:', data);
                console.log('[room_select] éƒ¨å±‹åœ§ç¸®çµ±è¨ˆ:', {
                    success: data.success,
                    count: data.count,
                    compressionRatio: data.compressionRatio,
                    timeSavedMs: data.timeSavedMs
                });
                
                if (data.success === false) {
                    console.error('[room_select] Light APIã‚¨ãƒ©ãƒ¼:', data.error);
                    throw new Error(`éƒ¨å±‹è»½é‡APIã‚¨ãƒ©ãƒ¼: ${data.error}`);
                }
                
                // Step 4: ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
                rooms = data.data?.rooms || data.data || [];
                propertyName = data.data?.propertyName || sessionPropertyName || 'ç‰©ä»¶åä¸æ˜';
                
                if (!Array.isArray(rooms)) {
                    console.error('[room_select] éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ã¯ãªã„:', rooms);
                    throw new Error('éƒ¨å±‹è»½é‡APIã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
                
                console.log('[room_select] ğŸ“‹ è»½é‡APIãƒ‡ãƒ¼ã‚¿è¨­å®š:', rooms.length, 'ä»¶');
                
                // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                if (window.pwaUtils && rooms.length > 0) {
                    const roomCacheData = {
                        data: rooms,
                        propertyName: propertyName,
                        timestamp: Date.now(),
                        source: 'getRoomsLight'
                    };
                    window.pwaUtils.setCacheData(roomCacheKey, roomCacheData);
                    console.log('[room_select] ğŸ’¾ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å®Œäº†');
                }
                
                console.log('[room_select] ç‰©ä»¶åè¨­å®š:', propertyName);
                document.getElementById('propertyName').textContent = propertyName;
                
                console.log('[room_select] displayRoomså‘¼ã³å‡ºã—é–‹å§‹');
                displayRooms(rooms);
                console.log('[room_select] updateCompleteButtonå‘¼ã³å‡ºã—é–‹å§‹');
                updateCompleteButton(rooms);
                
            } catch (error) {
                console.error('[room_select] âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', error);
                showError(error.message);
            } finally {
                console.log('[room_select] ğŸ finallyå‡¦ç†é–‹å§‹ - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤');
                hideLoadingElement();
                disableLoadingBlock();
                
                // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
                if (window.forceRefreshData) {
                    console.log('[room_select] ğŸ§¹ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ã‚¯ãƒªã‚¢');
                    window.forceRefreshData = false;
                    window.updatedRoomId = null;
                }
                
                console.log('[room_select] âœ… disableLoadingBlockå®Œäº†');
            }
        }

        // å¾“æ¥APIç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        async function loadRoomDataLegacy(propertyId, gasWebAppUrl) {
            console.log('[room_select] ğŸ”„ å¾“æ¥APIä½¿ç”¨ - getRooms (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)');
            
            const fetchUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${encodeURIComponent(propertyId)}`;
            const response = await fetch(fetchUrl);
            
            if (!response.ok) {
                throw new Error(`APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('[room_select] å¾“æ¥API Response:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            
            let propertyName = 'ç‰©ä»¶åä¸æ˜';
            if (data.data) {
                propertyName = data.data.propertyName
                    || (data.data.property && data.data.property.name)
                    || data.data.property_name
                    || data.data.name
                    || sessionStorage.getItem('selectedPropertyName')
                    || 'ç‰©ä»¶åä¸æ˜';
            }
            
            let rooms = (data.data && Array.isArray(data.data.rooms)) ? data.data.rooms : [];
            
            if (!Array.isArray(rooms)) {
                throw new Error('éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆroomsãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');
            }
            
            console.log('[room_select] ğŸ“‹ å¾“æ¥APIéƒ¨å±‹ãƒ‡ãƒ¼ã‚¿è¨­å®š:', rooms.length, 'ä»¶');
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            if (window.pwaUtils && rooms.length > 0) {
                const roomCacheKey = `rooms_${propertyId}`;
                const roomCacheData = {
                    data: rooms,
                    propertyName: propertyName,
                    timestamp: Date.now(),
                    source: 'getRooms'
                };
                window.pwaUtils.setCacheData(roomCacheKey, roomCacheData);
                console.log('[room_select] ğŸ’¾ å¾“æ¥APIéƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å®Œäº†');
            }
            
            document.getElementById('propertyName').textContent = propertyName;
            displayRooms(rooms);
            updateCompleteButton(rooms);
        }

        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å·®åˆ†æ›´æ–°ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
        async function performRoomDeltaUpdateBackground(propertyId, lastTimestamp = null) {
            console.log('[room_select] ğŸ”„ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å·®åˆ†æ›´æ–°é–‹å§‹:', { 
                propertyId, 
                lastTimestamp: lastTimestamp ? new Date(lastTimestamp).toLocaleString() : 'åˆå›' 
            });
            
            try {
                const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
                if (!gasWebAppUrl) {
                    console.warn('[room_select] gasWebAppUrlæœªè¨­å®š - å·®åˆ†æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                const timestamp = lastTimestamp || Date.now() - (24 * 60 * 60 * 1000); // 24æ™‚é–“å‰ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                const deltaUrl = `${gasWebAppUrl}?action=getDeltaData&dataType=rooms&propertyId=${propertyId}&lastSync=${timestamp}&cache=${Date.now()}`;
                console.log('[room_select] å·®åˆ†æ›´æ–°URL:', deltaUrl);
                
                const response = await fetch(deltaUrl);
                if (!response.ok) {
                    console.warn('[room_select] å·®åˆ†æ›´æ–°APIå¤±æ•— - ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                const deltaData = await response.json();
                console.log('[room_select] å·®åˆ†ãƒ‡ãƒ¼ã‚¿:', deltaData);
                
                if (deltaData.success && deltaData.data && deltaData.data.length > 0) {
                    console.log('[room_select] ğŸ“Š å·®åˆ†ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š:', deltaData.data.length, 'ä»¶');
                    
                    // ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¸
                    const roomCacheKey = `rooms_${propertyId}`;
                    const currentCache = window.pwaUtils?.getCacheData(roomCacheKey);
                    
                    if (currentCache && currentCache.data) {
                        const mergedData = window.pwaUtils.mergeData(currentCache.data, deltaData.data);
                        
                        // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                        const updatedCache = {
                            data: mergedData,
                            propertyName: currentCache.propertyName,
                            timestamp: Date.now(),
                            source: 'room_delta_update'
                        };
                        window.pwaUtils.setCacheData(roomCacheKey, updatedCache);
                        console.log('[room_select] ğŸ’¾ å·®åˆ†æ›´æ–°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å®Œäº†');
                        
                        // è¡¨ç¤ºä¸­ã®ç”»é¢ã‚‚æ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ°—ã¥ã‹ãªã„ãƒ¬ãƒ™ãƒ«ã§ï¼‰
                        displayRooms(mergedData);
                        updateCompleteButton(mergedData);
                        console.log('[room_select] ğŸ”„ ç”»é¢è¡¨ç¤ºã‚‚æ›´æ–°å®Œäº†');
                    }
                } else {
                    console.log('[room_select] ğŸ“Š å·®åˆ†ãƒ‡ãƒ¼ã‚¿ãªã— - æœ€æ–°çŠ¶æ…‹ã‚’ç¶­æŒ');
                }
            } catch (deltaError) {
                console.warn('[room_select] âš ï¸ å·®åˆ†æ›´æ–°ã‚¨ãƒ©ãƒ¼:', deltaError.message);
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ã®éè¡¨ç¤ºå‡¦ç†ã‚’å…±é€šåŒ–
        function hideLoadingElement() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
                loadingElement.style.visibility = 'hidden';
                loadingElement.style.opacity = '0';
                loadingElement.style.pointerEvents = 'none';
                loadingElement.style.zIndex = '-1';
                console.log('[room_select] loadingè¦ç´ å®Œå…¨éè¡¨ç¤ºå®Œäº†');
            } else {
                console.error('[room_select] loadingè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¿…ãšéè¡¨ç¤ºã«ã™ã‚‹
        function hideLoadingOnPageShow() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
                loadingElement.style.visibility = 'hidden';
                loadingElement.style.opacity = '0';
                loadingElement.style.pointerEvents = 'none';
                loadingElement.style.zIndex = '-1';
            }
            document.body.style.overflow = '';
            document.body.style.pointerEvents = '';
        }

        window.addEventListener('pageshow', function(event) {
            hideLoadingOnPageShow();
        });

        function displayRooms(rooms) {
            console.log('[room_select] displayRoomsé–‹å§‹:', rooms.length, 'ä»¶');
            const roomGrid = document.getElementById('roomGrid');
            const loading = document.getElementById('loading');
            
            if (!roomGrid) {
                console.error('[room_select] roomGridè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            roomGrid.innerHTML = '';
            
            if (rooms.length === 0) {
                console.log('[room_select] éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã®ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º');
                roomGrid.innerHTML = '<div class="no-rooms-message">éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                roomGrid.style.display = 'block';
                // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã®å ´åˆã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œå…¨éè¡¨ç¤º
                if (loading) {
                    loading.style.display = 'none';
                    loading.style.visibility = 'hidden';
                    loading.style.opacity = '0';
                    loading.style.pointerEvents = 'none';
                    loading.style.zIndex = '-1';
                    console.log('[room_select] 0ä»¶æ™‚ã®loadingå®Œå…¨éè¡¨ç¤ºå®Œäº†');
                }
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('propertyId');
            
            console.log('[room_select] éƒ¨å±‹ã‚«ãƒ¼ãƒ‰ä½œæˆé–‹å§‹');
            rooms.forEach((room, index) => {
                console.log(`[room_select] éƒ¨å±‹[${index}]å‡¦ç†:`, room.name || room['éƒ¨å±‹å'] || room.id);
                
                // æ¤œé‡ä¸è¦ãƒ•ãƒ©ã‚°ã®ç¢ºèªï¼ˆæ–°ã—ã„isNotNeededãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ï¼‰
                const isSkipInspection = room.isNotNeeded === true;
                
                // Material UI Cardæ§‹é€ 
                const card = document.createElement('div');
                let cardClasses = 'MuiCard-root MuiPaper-root MuiPaper-elevation1 MuiCardActionArea-root room-card';
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (isSkipInspection) {
                    cardClasses += ' status-skip';
                } else if (room.readingStatus === 'completed' || room.isCompleted) {
                    cardClasses += ' status-completed';
                } else {
                    cardClasses += ' status-pending';
                }
                
                card.className = cardClasses;
                card.setAttribute('tabindex', isSkipInspection ? '-1' : '0');
                card.setAttribute('role', isSkipInspection ? 'presentation' : 'button');
                
                // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ©ãƒ™ãƒ«
                let ariaLabel = String(room.name || room['éƒ¨å±‹å'] || room.id || 'ä¸æ˜');
                if (isSkipInspection) {
                    ariaLabel += ' æ¤œé‡ä¸è¦';
                } else if (room.readingStatus === 'completed') {
                    ariaLabel += ' æ¤œé‡æ¸ˆã¿';
                } else {
                    ariaLabel += ' æœªæ¤œé‡';
                }
                card.setAttribute('aria-label', ariaLabel);
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã®æ±ºå®š
                let statusIcon, statusColor, statusText;
                if (isSkipInspection) {
                    statusIcon = 'block';
                    statusColor = '#9e9e9e';
                    statusText = 'æ¤œé‡ä¸è¦';
                } else if (room.readingStatus === 'completed') {
                    statusIcon = 'check_circle';
                    statusColor = '#2e7d32';
                    statusText = room.readingDateFormatted ? `æ¤œé‡æ¸ˆã¿ï¼š${String(room.readingDateFormatted)}` : 'æ¤œé‡æ¸ˆã¿';
                } else {
                    statusIcon = 'warning';
                    statusColor = '#ed6c02';
                    statusText = 'æœªæ¤œé‡';
                }
                
                card.innerHTML = `
                  <div class="MuiCardContent-root room-info-row">
                    <span class="material-icons MuiSvgIcon-root status-icon" aria-hidden="true" style="color:${statusColor};">
                      ${statusIcon}
                    </span>
                    <span class="MuiTypography-root MuiTypography-h6 room-name">${String(room.name || room['éƒ¨å±‹å'] || room.id || 'ä¸æ˜')}</span>
                    <span class="MuiTypography-root MuiTypography-body2 room-status">${statusText}</span>
                  </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ¤œé‡ä¸è¦ã®å ´åˆã¯ç„¡åŠ¹ï¼‰
                if (!isSkipInspection) {
                    card.onclick = () => {
                        // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const roomId = String(room.id || '');
                        preloadMeterReadingData(propertyId, roomId);
                        
                        const meterReadingUrl = `/reading?propertyId=${encodeURIComponent(propertyId)}&roomId=${encodeURIComponent(roomId)}`;
                        window.location.href = meterReadingUrl;
                    };
                    
                    // ãƒ›ãƒãƒ¼æ™‚ã«ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼‰
                    card.onmouseenter = () => {
                        const roomId = String(room.id || '');
                        setTimeout(() => preloadMeterReadingData(propertyId, roomId), 200);
                    };
                    
                    addRippleEffect(card);
                } else {
                    // æ¤œé‡ä¸è¦ã®å ´åˆã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã«èª¬æ˜ã‚’è¡¨ç¤º
                    card.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('ã“ã®éƒ¨å±‹ã¯æ¤œé‡ä¸è¦ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚');
                        return false;
                    };
                }
                
                roomGrid.appendChild(card);
            });
            
            console.log('[room_select] éƒ¨å±‹ã‚«ãƒ¼ãƒ‰ä½œæˆå®Œäº†ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã¨ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º');
            if (loading) {
                loading.style.display = 'none';
                loading.style.visibility = 'hidden';
                loading.style.opacity = '0';
                loading.style.pointerEvents = 'none';
                console.log('[room_select] loadingå®Œå…¨éè¡¨ç¤ºè¨­å®šå®Œäº†');
            }
            roomGrid.style.display = 'grid';
            
            // è¡¨ç¤ºå®Œäº†å¾Œã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹
            setTimeout(() => {
                performBatchPreload(rooms, propertyId);
            }, 1000);
            
            console.log('[room_select] displayRoomså®Œäº†');
        }

        function updateCompleteButton(rooms) {
            const completeBtn = document.getElementById('completeInspectionBtn');
            
            // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒ1ä»¶ä»¥ä¸Šã‚ã‚Œã°å¸¸ã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            if (rooms.length > 0) {
                completeBtn.style.display = 'flex';
                completeBtn.innerHTML = `
                    <span class="material-icons MuiSvgIcon-root">check_circle</span>
                    <span class="MuiButton-label">ã“ã®ç‰©ä»¶ã®æ¤œé‡ã‚’å®Œäº†ã™ã‚‹</span>
                `;
                console.log('[room_select] æ¤œé‡å®Œäº†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º');
            } else {
                completeBtn.style.display = 'none';
                console.log('[room_select] éƒ¨å±‹ãŒãªã„ãŸã‚æ¤œé‡å®Œäº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º');
            }
        }

        async function completeInspection() {
            console.log('[room_select] æ¤œé‡å®Œäº†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
            
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('propertyId');
            
            if (!propertyId) {
                alert('ç‰©ä»¶IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }
            
            // gasWebAppUrlã‚’é–¢æ•°å†…ã§å–å¾—ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
            const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
            if (!gasWebAppUrl) {
                alert('Web App URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                // ç¾åœ¨ã®æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã§å–å¾—
                const today = new Date();
                const completionDate = today.getFullYear() + '-' + 
                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(today.getDate()).padStart(2, '0');
                
                console.log(`[completeInspection] æ¤œé‡å®Œäº†å‡¦ç†é–‹å§‹ - ç‰©ä»¶ID: ${propertyId}, å®Œäº†æ—¥: ${completionDate}`);
                
                // GAS APIå‘¼ã³å‡ºã—
                const response = await fetch(`${gasWebAppUrl}?action=completeInspection&propertyId=${propertyId}&completionDate=${completionDate}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('[completeInspection] APIå¿œç­”:', result);
                
                if (result.success) {
                    alert(`æ¤œé‡å®Œäº†æ—¥ã‚’ ${completionDate} ã§ä¿å­˜ã—ã¾ã—ãŸï¼`);
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’åæ˜ 
                    window.location.reload();
                } else {
                    throw new Error(result.error || 'æ¤œé‡å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('[completeInspection] ã‚¨ãƒ©ãƒ¼:', error);
                alert(`æ¤œé‡å®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šãƒšãƒ¼ã‚¸ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        const preloadCache = new Map(); // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        
        async function preloadMeterReadingData(propertyId, roomId) {
            const preloadKey = `${propertyId}_${roomId}`;
            
            // æ—¢ã«ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã¾ãŸã¯å®Ÿè¡Œä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (preloadCache.has(preloadKey)) {
                console.log('[room_select] ğŸš€ ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå®Ÿè¡Œæ¸ˆã¿ï¼‰:', preloadKey);
                return;
            }
            
            preloadCache.set(preloadKey, 'loading');
            console.log('[room_select] ğŸ”„ ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šãƒ‡ãƒ¼ã‚¿ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹:', { propertyId, roomId });
            
            try {
                const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
                if (!gasWebAppUrl) {
                    console.warn('[room_select] gasWebAppUrlæœªè¨­å®š - ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                // æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆè»½é‡ç‰ˆã‚’å„ªå…ˆï¼‰
                const preloadUrl = `${gasWebAppUrl}?action=getMeterReadingDataLight&propertyId=${propertyId}&roomId=${roomId}&cache=${Date.now()}`;
                console.log('[room_select] ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰URL:', preloadUrl);
                
                const response = await fetch(preloadUrl);
                if (!response.ok) {
                    console.warn('[room_select] ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å¤±æ•—:', response.status);
                    preloadCache.delete(preloadKey);
                    return;
                }
                
                const data = await response.json();
                console.log('[room_select] ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†:', data);
                
                if (data.success && window.pwaUtils) {
                    // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                    const meterCacheKey = `meter_${propertyId}_${roomId}`;
                    const meterCacheData = {
                        data: data.data,
                        timestamp: Date.now(),
                        source: 'preload_getMeterReadingDataLight'
                    };
                    
                    window.pwaUtils.setCacheData(meterCacheKey, meterCacheData);
                    console.log('[room_select] ğŸ’¾ ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å®Œäº†');
                    preloadCache.set(preloadKey, 'completed');
                } else {
                    console.warn('[room_select] ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç„¡åŠ¹:', data);
                    preloadCache.delete(preloadKey);
                }
                
            } catch (error) {
                console.warn('[room_select] âš ï¸ ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error.message);
                preloadCache.delete(preloadKey);
            }
        }
        
        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ä¸€æ‹¬ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆè¡¨ç¤ºå®Œäº†å¾Œã«å®Ÿè¡Œï¼‰
        function performBatchPreload(rooms, propertyId) {
            console.log('[room_select] ğŸ”„ ä¸€æ‹¬ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹:', rooms.length, 'ä»¶');
            
            // æœ€åˆã®3ã¤ã®éƒ¨å±‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰å–å¾—ï¼ˆå„ªå…ˆåº¦é †ï¼‰
            const priorityRooms = rooms
                .filter(room => room.isNotNeeded !== true) // æ¤œé‡ä¸è¦ä»¥å¤–
                .filter(room => room.readingStatus !== 'completed') // æœªå®Œäº†ã®ã¿
                .slice(0, 3); // æœ€åˆã®3ä»¶
                
            priorityRooms.forEach((room, index) => {
                const delay = index * 1000; // 1ç§’é–“éš”ã§å®Ÿè¡Œ
                setTimeout(() => {
                    const roomId = String(room.id || '');
                    preloadMeterReadingData(propertyId, roomId);
                }, delay);
            });
            
            console.log('[room_select] ğŸ“Š ä¸€æ‹¬ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å¯¾è±¡:', priorityRooms.length, 'ä»¶');
        }

        function goBack() {
            console.log('[room_select] æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
            
            try {
                // ç¾åœ¨ã®URLã¨ãƒ™ãƒ¼ã‚¹URLã‚’ç¢ºèª
                const currentUrl = window.location.href;
                const baseUrl = window.location.origin;
                console.log('[room_select] ç¾åœ¨ã®URL:', currentUrl);
                console.log('[room_select] ãƒ™ãƒ¼ã‚¹URL:', baseUrl);
                
                // æ–°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ å¯¾å¿œã®ãƒ‘ã‚¹ï¼ˆCloudflare Pageså¯¾å¿œï¼‰
                const possiblePaths = [
                    '/property',                                // æ–°æ§‹é€ ãƒ»çµ¶å¯¾ãƒ‘ã‚¹ (å„ªå…ˆ)
                    '../property/',                             // æ–°æ§‹é€ ãƒ»ç›¸å¯¾ãƒ‘ã‚¹
                    '/property_select.html',                    // å¾Œæ–¹äº’æ›ãƒ»çµ¶å¯¾ãƒ‘ã‚¹
                    `${baseUrl}/property`                       // æ–°æ§‹é€ ãƒ»æ˜ç¤ºçš„çµ¶å¯¾ãƒ‘ã‚¹
                ];
                
                console.log('[room_select] é·ç§»å…ˆå€™è£œ (ç›¸å¯¾ãƒ‘ã‚¹å„ªå…ˆ):', possiblePaths);
                
                // ç›¸å¯¾ãƒ‘ã‚¹å„ªå…ˆã§é·ç§»ã‚’è©¦è¡Œ
                const targetPath = possiblePaths[0];
                console.log(`[room_select] ğŸš€ é·ç§»å®Ÿè¡Œ: ${targetPath}`);
                
                // é·ç§»å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
                sessionStorage.setItem('navigationSource', 'room_select_back_button');
                sessionStorage.setItem('navigationTime', new Date().toISOString());
                
                // é·ç§»å®Ÿè¡Œ
                window.location.href = targetPath;
                
            } catch (error) {
                console.error('[room_select] æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                try {
                    // ç›´æ¥çš„ãªç›¸å¯¾ãƒ‘ã‚¹é·ç§»
                    console.warn('[room_select] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›¸å¯¾ãƒ‘ã‚¹é·ç§»å®Ÿè¡Œ');
                    window.location.href = 'property_select.html';
                } catch (fallbackError) {
                    console.error('[room_select] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é·ç§»ã‚‚ã‚¨ãƒ©ãƒ¼:', fallbackError);
                    
                    // ğŸ”§ è¨ºæ–­æƒ…å ±ã‚’åé›†
                    if (window.navigationDiagnostics) {
                        console.log('ğŸ”¬ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨ºæ–­å®Ÿè¡Œä¸­...');
                        window.navigationDiagnostics.testPaths().then(results => {
                            console.log('ğŸ“Š ãƒ‘ã‚¹è§£æ±ºãƒ†ã‚¹ãƒˆçµæœ:', results);
                        });
                    }
                    
                    // æœ€å¾Œã®æ‰‹æ®µ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
                    const userAction = confirm(
                        'ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' +
                        'OK: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†è©¦è¡Œ\n' +
                        'ã‚­ãƒ£ãƒ³ã‚»ãƒ«: æ‰‹å‹•ã§ç‰©ä»¶é¸æŠç”»é¢ã¸ç§»å‹•'
                    );
                    
                    if (userAction) {
                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã«å†è©¦è¡Œ
                        if (window.navigationDiagnostics) {
                            console.log('ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ & å†è©¦è¡Œ');
                            window.navigationDiagnostics.clearCache().then(() => {
                                console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº† - é·ç§»å†è©¦è¡Œ');
                                window.location.href = 'property_select.html';
                            });
                        } else {
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å˜ç´”ãªé·ç§»
                            window.location.href = 'property_select.html';
                        }
                    } else {
                        // æ‰‹å‹•é·ç§»ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                        try {
                            window.open('property_select.html', '_self');
                        } catch (finalError) {
                            alert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚è‡ªå‹•é·ç§»ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«ã€Œproperty_select.htmlã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                            console.error('[room_select] æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚ã‚¨ãƒ©ãƒ¼:', finalError);
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
